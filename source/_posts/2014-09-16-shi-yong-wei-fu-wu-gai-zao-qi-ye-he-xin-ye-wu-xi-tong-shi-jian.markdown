---
layout: post
title: "使用微服务改造企业核心业务系统实践之如何快速发开微服务应用"
date: 2014-09-16 21:57
comments: true
categories: Microservice
---

##背景与挑战

随着公司国际化战略的推行以及本土业务的高速发展，后台支撑系统已经不堪重负。在吞吐量、稳定性以及可扩展性上都无法满足日益增长的业务需求。对于每10万元额度的合同，从销售团队准备材料、与客户签单、递交给合同部门，再到合同生效大概需要3.5人天。随着业务量的快速增长，签订合同的成本急剧增加。

合同管理系统是后台支撑系统中重要的一部分。当前的合同系统是5年前使用.NET、基于[SAGE CRM](http://www.sagecrm.com/asia/)二次开发的产品。
一方面，系统架构过于陈旧，性能、可靠性无法满足现有的需求。另一方面，功能繁杂，结构混乱，定制的代码与SAGE CRM系统耦合度极高。

由于是遗留系统，熟悉该代码的人早已离职多时，新团队对其望而却步，只能做些周边的修补工作。同时，还要承担着边补测试，边整理逻辑的工作。

在无法中断业务处理的情况下，为了解决当前面临的问题，交付团队制定了如下的策略：

<img src="{{ root_url }}/images/microservice/crm-rebuild-strategy-600x400.png" />

1. 在现有合同管理系统的外围，构建功能服务接口，将系统核心的功能分离出来。
2. 利用这些功能服务接口作为代理，解耦原有系统与其调用者之间的依赖；
3. 通过不断构建功能服务接口，逐渐将原有系统分解成多个独立的服务。
4. 摒弃原有的合同管理系统，并使用新构建的一组服务替代。

接下来的主要矛盾就是如何定义并实现这些服务接口了。

##什么是微服务
多年来，我们一直在技术的浪潮中不断乘风破浪，扬帆奋进，寻找更好的方式构建IT系统。

微服务架构(Micro Service Architect)，是近一段时间在软件体架构领域里出现的一个新名词。它通过将功能分解到多个独立的服务中以实现对解决方案或者复杂系统的解耦。

微服务的诞生并非偶然：[领域驱动设计](http://baike.baidu.com/view/3705331.htm?fr=aladdin)指导我们如何分析并模型化复杂的业务；[敏捷方法论](http://baike.baidu.com/view/10087780.htm)帮助我们消除浪费，快速反馈；[持续交付]()帮助我们实现了更快、更可靠、更频繁的软件部署和交付；虚拟化和基础设施自动化则帮助我们简化环境的创建、安装；DevOps活动的流行以及特性团队的出现，使得小团队更加全功能化。这些都是推动微服务诞生的重要因素。

实际上，微服务本身并没有一个严格的定义。不过从业界的讨论来看，微服务通常有如下几个特征:

### 小，且专注于做一件事情
每个服务都是个很小的应用，至于有多小，是一个非常有争议的话题。有人喜欢100行以内，有人赞成1000行以内。数字并不是最重要的，仁者见仁，智者见智，只要团队觉得合适就好。

只关注一个业务功能。这一点和我们平常谈论的面向对象原则中的"单一原则"类似，每个服务只做一件事情，并且把它做好。

### 运行在独立的进程中
每个服务都运行在一个独立的操作系统进程，这意味着不同的服务能被部署到不同的主机上。

### 轻量级的通信机制
服务和服务之间通过轻量级的机制实现彼此间的通信。所谓轻量级，通常指语言无关、平台无关的这类协议，例如XML，JSON，而不是传统我们熟知的Java RMI或者.Net Remoting等。

### 松耦合
不需要改变依赖，只更改当前服务本身，就可以独立部署。这意味着该服务和其他系统或者服务之间呈现松耦合的状态。

综上所述，微服务是用一组服务协作的方式构建一个应用。每个服务独立运行在不同的进程中，服务之与服务之间通过轻量的通讯机制交互，并且每个服务可以通过自动化部署方式独立部署。

##微服务的优势

相比传统的单块架构系统(monolithic)，微服务在如下诸多方面有着显著的优势：

#### 异构性

问题有其具体性，解决方案也应有其针对性。用最适合的技术方案去解决具体的问题，往往会事半功倍。传统的单块架构系统倾向采用统一的技术平台或方案来解决所有问题。而微服务的异构性，可以针对不同的业务特征选择不同的技术方案，有针对性的解决具体的业务问题。

对于单块架构的系统，初始的技术选型严重限制将来采用不同语言或框架的能力。如果想尝试新的编程语言或者框架，没有完备的功能测试集，很难平滑的完成替换，而且系统规模越大，风险越高。基于微服务架构，使我们更容易地在遗留系统上尝试新的技术或解决方案。譬如说，
可以先挑选风险最小的服务作为尝试，快速得到反馈后再决定是否试用于其他服务。这也意味着，即便对一项新技术的尝试失败的话，尽可以抛弃这个方案，并不会对整个产品带来风险。

<img src="{{ root_url }}/images/microservice/micro-service-advantages-600x400.png" />

#### 独立测试与部署
单块架构系统运行在一个进程中，因此系统中任何程序的改变，都需要对整个系统重新测试并部署。
而对微服务架构而言，不同服务之间的打包、测试或者部署等，与其它服务都是完全独立的。对某个服务所做的改动，只需要关注该服务本身。从这个角度来说，使用微服务后，代码修改、测试、打包以及部署的成本和风险都比单块架构系统降低很多。

#### 按需伸缩
单块架构系统由于单进程的局限性，水平扩展时只能基于整个系统进行扩展，无法针对某一个功能模块按需扩展。
而服务架构则可以完美的解决伸缩性的扩展问题。系统可以根据需要，实施细粒度的自由扩展。

#### 错误隔离性
微服务架构同时也能提升故障的隔离性。例如，如果某个服务的内存泄露，则只会影响到自己，其他服务能够继续正常地工作。与之形成对比的是，单块架构中如果有一个不合格的组件发生异常，有可能会拖垮整个系统。

#### 团队全功能化

康威定律（Conway's law）指出：

```organizations which design systems are constrained to produce designs which are copies of the communication structures of these organizations.```

```一个组织的设计成果，其结构往往对应于这个组织中的沟通结构。```

传统的开发模式在分工时往往以技术为单位，比如UI团队、服务端团队和数据库团队，这样的分工可能会导致任何功能上的改变都需要跨团队沟通和协调。而微服务则倡导围绕服务来分工，团队需要具备服务设计、开发、测试到部署所需的所有技能。

##微服务快速开发

随着团队对业务的理解加深和对微服务实践的尝试，新的问题出现了：对于不同的微服务，虽然具体实现的代码细节不同，但其结构、开发方式、持续集成环境、测试策略、部署机制以及监控和告警等，都有着类似的开发方式。那么如何消除浪费，简化这一套开发流程呢？

带着这个问题，经过团队的努力，Stencil诞生了。
Stencil是一个帮助快速构建Ruby微服务应用的开发框架，主要包括四部分：Stencil模板、代码生成工具，持续集成模板以及一键部署工具。

<img src="{{ root_url }}/images/microservice/stencil-template-structure-details-600x400.png" />

###Stencil模板

Stencil模板是一个独立的Ruby代码工程库，主要包括代码模板以及一组配置文件模板。

代码模板使用Webmachine作为Web框架，RESTful和JSON作为服务之间的通信机制，RSpec作为测试框架。同时，模板还定义了一组Rake任务，譬如运行测试，查看测试报告，将当前的微服务生成RPM包，并使用Koji给RPM包打tag。除此之外，模板也提供了一组用于诊断的URL，帮助查看当前微服务的版本、查看配置信息以及检测应用是否健康的运行等。

	[
		{
			rel: "index",
			path: "/diagnostic/"
		},
		{
			rel: "version",
			path: "/diagnostic/version"
		},
		{
			rel: "warmup",
			path: "/diagnostic/warmup"
		},
		{
			rel: "config",
			path: "/diagnostic/config"
		},
		{
			rel: "hostname",
			path: "/diagnostic/hostname"
		},
		{
			rel: "heartbeat",
			path: "/diagnostic/status/heartbeat"
		},
		{
			rel: "nagios",
			path: "/diagnostic/status/nagios"
		},
		{
			rel: "diagnosis",
			path: "/diagnostic/status/diagnosis"
		}
	]


配置文件模板主要包括[NewRelic](http://newrelic.com/)配置，[Passenger](https://www.phusionpassenger.com/)配置、[Nagios](http://www.nagios.org/)配置、[Apache](http://httpd.apache.org/)配置以及[Splunk](http://www.splunk.com/)配置。意味着当我们把这个新的应用服务部署到验收或者产品环境，我们立即就可以使用Nagios、NewRelic以及Splunk等工具提供的功能帮助我们监控应用并获得告警。

通过这个Stencil模板，我们就能在很短的时间内生成一个可以运行的微服务应用，并使用部署工具将其立刻部署到验收环境(Staging)上。
随着系统越来越复杂，微服务应用的不断增多，Stencil模板帮助我们大大简化了创建、部署等通用的操作，让开发人员更关注如何实现业务逻辑，部署并验证。


###代码生成工具
借助Stencil代码生成工具，我们可以得到不同类型的服务。
例如，有些服务具有数据库访问能力、有些服务包含异步队列的处理，或者某些服务是消费者，某些服务是生产者等。


	Create a project from the stencil template (version 0.1.27)
	        --name, -n <s>:   New project name. eg. things-and-stuff
	   --git-owner, -g <s>:   Git owner (default: which team or owner)
	        --database, -d:   Include database connection code
	  --triggered-task, -t:   Include triggered task code
	        --provider, -p:   Is it a service provider? (other services use this service)
	        --consumer, -c:   Is it a service consumer? (it uses other services)
	      --branch, -b <s>:   Specify a particular branch of Stencil
	       --face-palm, -f:   Overide name validation 
	            --help, -h:   Show this message

###持续集成模板
基于持续集成服务器Bamboo，团队创建了针对Stencil的持续集成模板工程，并定义了三个阶段：
	- 打包：运行单元测试，待测试通过后生成RPM包。
	- 发布：将RPM包发布到Koji服务器，并打上相应的Tag，然后使用Packer在亚马逊的AWS服务中创建AMI。该AMI已经安装了当前构建的RPM包。
	- 部署：基于指定版本的AMI，将应用快速部署到验收环境或者产品环境上。

利用持续集成模板工程，团队仅需花费很少的时间，就可以针对新建的应用服务，在Bamboo上快速定义其对应的持续集成环境。

###一键部署工具
所有的应用服务都部署并运行在亚马逊AWS云环境上。同时，我们使用[Asgard](https://github.com/Netflix/asgard)对AWS云环境中的资源进行创建和管理。
Asgard是一套功能强大的基于Web的AWS云应用部署和管理工具，由Netflix采用[Groovy on Grails](	http://grails.org/)开发，其主要优点有：
	- 基于B/S的AWS部署及管理工具，使用户能通过浏览器直接访问AWS云资源，无需设置Secret Key和Access Key；
	- 定义了`Application`以及`Cluster`等逻辑概念，更清晰、有效地描述了应用程序在AWS云环境中对应的部署拓扑结构。
	- 在对应用的部署操作中，集成了AWS Elastic Load Balancer、AWS EC2以及AWS Autoscaling Group，并将这些资源自动关联起来。
	- 提供RESTful接口，能够方便的与其他系统集成。
	- 简洁易用的UI，提供可视化的方式完成一键部署以及流量切换。


由于Asgard对RESTful的良好支持，团队实现了一套基于Asgard的命令行部署工具，只需如下一条命令，提供应用程序的名称以及版本号，就可自动完成资源的创建、部署、流量切换、删除旧的应用等操作。

	asgard-deploy [AppName] [AppVersion]

同时，基于命令行的部署工具，也可以很容易的将自动化部署集成到Bamboo持续集成环境。


通过使用微服务框架Stencil，大大缩短了团队开发微服务的周期。同时，基于Stencil，我们定义了一套团队内部的开发流程，帮助团队的每一位成员理解并快速构建微服务。


##微服务架构下的新系统

经过3个月的努力，我们有效的重新构建了合同管理系统，将之前的产品、价格、销售人员、合同审查以及PDF合同的生成都定义成独立的服务接口。相比之前大而全、难以维护的合同管理系统而言，新的系统由不同功能的微服务组成，每个微服务程序只关注单一的功能。每个微服务应用都有相关的负责人，通过使用[Page Duty](http://www.pagerduty.com/)，当监控出现告警的时候，责任人能立即收到消息并快速响应。

<img src="{{ root_url }}/images/microservice/condor-sample-app-600x400.png" />


同时，由于微服务具有高内聚，低耦合的特点，每个应用都是一个独立的个体，因此很容易定位问题并解决问题，大大缩短了修复缺陷的周期。
另外，通过使用不同功能的微服务接口来提供数据，用户接口(UI)部分变成了一个非常简洁、轻量级的应用，更关注如何渲染页面以及表单提交等交互功能。

###总结
通过使用微服务架构，在不影响现有业务运转的情况下，我们有效的将遗留的大系统逐渐分解成不同功能的微服务接口。

同时，通过Stencil微服务开发框架，我们能够快速的构建不同功能的微服务接口，并能方便的将其部署到验收环境或者产品环境。


最后，得益于微服务架构的灵活性以及扩展性，使得我们能够构建低耦合、易扩展、易伸缩性的应用。




